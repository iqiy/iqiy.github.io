---
layout: post
title: "SLAM学习笔记（八）"
subtitle: "后端"
date: 2020-09-6 17:20:18
author: "QIY"
header-img: "img/SLAM.png"
header-mask: 0.3
catalog: true
tags:
    - SLAM
---
> 高翔老师SLAM14讲学习笔记
* TOC
{:toc}
后端
-   后端（Backend）(**状态估计问题**)
    -   从带噪声的数据估计内在状态——状态估计问题
    -   Estimated the inner state from noisy data
-   渐进式（Incremental）
    -   保持当前状态的估计，在加入新信息时，**更新已有的估计**（滤波）
-   批量式（Batch）
    -   给定一**定规模的数据**，计算该数据下的最优估计（优化）
# 1 状态估计问题
-   数学描述
    -   符号定义：
    -   t = 0 … N 时间内，机器人的位姿为：
        ![](/img/in-post/200906_slam8/afb5ebac67f6696c83e527c78aca3fa3.png)
        （相当于一个R、t），同时有路标
        ![](/img/in-post/200906_slam8/0ac906b6c7ca3752996d90f135b8a102.png)
        （三D点）
    -   运动和观测方程记为：
![](/img/in-post/200906_slam8/00222dbd94469c3d049cd903e11d3869.png)
f：非线性函数，Uk：运动输入量，wk：噪声量；
第二个公式呢：在k时刻对yj这个路标做一次观测，拿到了zk,j(2d点
u、v)，（对3D观测得到一个2D像素，就是这样一件事情），h也是一个非线性函数。
如果是纯视觉SLAM，没有对相机运行估计，没有相机运动的输入量、观测量，那只有下面这个式子（观测方程）。
整个过程可以理解为，**当你拿有噪声的数据时，任意时候只拿到了z 和
u，通过z和u去估计x0-xn和y0-yn服从怎样的一种分布**。一般是拿到x、y的联合分布。
-   用随机变量表示状态，估计其概率分布
-   k 时刻所有待估计的量组成k时刻状态：
    ![](/img/in-post/200906_slam8/893bfc4531a48891514343f96545631d.png)
    符号稍微有点冲突
-   k 时刻观测统一记成：
    ![](/img/in-post/200906_slam8/1a0fbc41ab4e0c6f91f763934dbc42c1.png)
    方程简化为：
![](/img/in-post/200906_slam8/026c1fff57c84b7f66eaaf6a9f0d4cd2.png)
-   根据过去0时刻到k时刻的数据
-   估计当前的状态：
    ![](/img/in-post/200906_slam8/65de28be8dd95b3efa467378680c6aaa.png)
-   Bayes展开：
    ![](/img/in-post/200906_slam8/8103fab5ad9b3a473df88f9edcc89e8b.png)
    （提取zk）
-   先验部分按条件概率展开：
![](/img/in-post/200906_slam8/dfa23259b8d729301c2d3a65c627542c.png)
>   k时刻受先前状态的影响 k-1时刻的状态估计
-   分歧：
    -   可以假设k时刻状态只和k-1时刻有关（假设了一阶马尔可夫性）
    -   或假设k时刻状态与先前所有时刻均有关（不假设马尔可夫性）
假设一阶马尔可夫性的情况：
![](/img/in-post/200906_slam8/228d254383c6baa44bd5bd3746f7277c.png)
（运行方程）
第二项：
![](/img/in-post/200906_slam8/11303236e3013e45a06260ea1ba51d52.png)
状态观测方程。
-   于是，该公式指出了如何从k-1时刻的状态分布递推至k时刻的分布
    -   只是现在我们还没有代入具体的分布形式
在线性模型、高斯状态分布下，我们将得到**卡尔曼滤波器**
在非线性模型、高斯状态分布下，可以在工作点附近线性展开，得到**扩展卡尔曼滤波器**
# 2 卡尔曼滤波器（KF）
目的：求
-   卡尔曼滤波器的推导
    -   线性模型和高斯噪声：
![](/img/in-post/200906_slam8/44868dcb54f4bd199b97969bb5f7a2ab.png)
![](/img/in-post/200906_slam8/642629c887576119924a358449df48f3.png)
（高斯白噪声）
状态的高斯分布（区别先后验）
![](/img/in-post/200906_slam8/be4e174e33a95841f0edb29a63f087d7.emf)
后验（仅通过运行方程推的话称为**后验，上尖尖**表示，假设k-1时刻是知道了，它满足一个高斯分布，均值是
![](/img/in-post/200906_slam8/9f048b21f21185fe53e97b1eddd05c54.png)
，协方差是
![](/img/in-post/200906_slam8/89a71b854fe01b04b99dcf6d38f2ea2f.png)
）
![](/img/in-post/200906_slam8/e8475d4cb0aff6a7780a71609f6d7988.emf)
**先验**（上**杠杠**）。
忽略计算，得
![](/img/in-post/200906_slam8/8f4f824f7449adf403346449702a065c.emf)
卡尔曼滤波的更新式：
![](/img/in-post/200906_slam8/bb45341f76395fd8b1a96fc30d26762e.emf)
总结：
经典卡尔曼滤波器的五个公式，给出了线性高斯系统的最优无偏估计
![](/img/in-post/200906_slam8/9d10ed8e499d41a23b1c6bfd0386e9f8.png)
10.24：使用运行方程，k-1的后验推k时刻的先验。
10.25-10.26：k时刻的先验推k时刻的后验。
# 3 扩展卡尔曼滤波器（EKF）
![](/img/in-post/200906_slam8/c49e823e57b20cff116719b946a938bf.png)
\-假设在工作点附近是一个线性系统，同样使用卡尔曼推导有：
![](/img/in-post/200906_slam8/5372b7a5020a20a209e39d91a501c1c8.png)
\-
-   EKF优点
    -   推导简单清楚，适用各种传感器形式
    -   易于做多传感器融合
-   EKF缺点
    -   一阶马尔可夫性过于简单
    -   可能会发散（要求数据不能有outlier，如 特征匹配错误）
    -   线性化误差（仅有一次迭代的线性优化问题）
    -   需要存储所有状态量的均值和方差，平方增长
# **4 BA与图优化**
**目的：BA与图优化结合，更好更快的优化BA。**
![](/img/in-post/200906_slam8/a31db8f707c4450dc41d4ad9c1c0c79b.png)
-   Bundle Adjustment已经在之前介绍过了
    -   事实上BA属于批量式的优化方法
    -   给定很多个相机位姿与观测数据，计算最优的状态估计
    -   定义每个运动/观测方程的误差，并从初始估计开始寻找梯度下降
![](/img/in-post/200906_slam8/9d4466c0068cd510bf8ef1e9071c363c.png)
-   BA问题与图结构的关系
    -   BA虽然是个纯优化问题，但亦可以用图模型清晰地表述出来
    -   顶点为优化变量，边为运动/观测约束
    -   本身还有一些特殊的结构
-   考虑在位姿 i 处对路标 j 的一次观测 zij：
![](/img/in-post/200906_slam8/a7fe50021c05515e51f356856ecffc55.emf)
特点：
-   每个观测只关系两个变量，其中一个是相机，一个是路标
-   纯视觉Ba中，不存在相机与相机/路标与路标之间的关联
-   整个误差函数由许多个这样小的项组成
如果对变量做好排序，例如所有相机位姿在前，路标在后，那么 H 有一定的特殊结构：
![](/img/in-post/200906_slam8/4e47e7da6bbacd9209ab305e60cb58bd.png)
图模型与H矩阵存在对应关系：**图模型中存在边=\>H相应地方出现非零块**。
-   实际当中的H，路标数量远大于位姿数量（箭头形矩阵或镐子形矩阵）
![](/img/in-post/200906_slam8/d1b3ac756432470b5aed013c08f305c5.png)
![](/img/in-post/200906_slam8/fe3eb3d9217cddf9bfd66af0e6e6e4cc.png)
-   利用H的特殊结构，可以大幅**加速Hx=-b线性方程的求解**
-   **加速手段又称边缘化**（Marginalization）[意义有很多种]
-   Hx=-b的结构（以下目的为了消元）：
![](/img/in-post/200906_slam8/255e9c0c271a1d65439a67df79289364.png)
B：小，对角块；C，大，对角块
E和E转置：与图模型对应，可稠密
-   因为 C 是对角块，**所以可以用C对E进行消元（高斯消元），**得到：
![](/img/in-post/200906_slam8/9f571737c2c3df96eaaf2c9f36ca35fa.png)
从而：
![](/img/in-post/200906_slam8/755f5f34dbfc6635a54a4866e8b51098.png)
-   该方程组分为两步来求：
    1.  求解上半部分，规模较小，得到
        ![](/img/in-post/200906_slam8/a9f8322dcaf75e15904ef67ff4f35073.emf)
    2.  将结果代入下半部分，得到
        ![](/img/in-post/200906_slam8/b06c53b2c867149c03303e54a450941c.emf)
-   这个做法称为Marginalization或Schur消元
    1.  **从消元角度来讲，亦可使用Cholesky等其他消元方式解此稀疏方程**
    2.  **从Marginalization角度来讲，是我们把所有的路标信息边缘化到了相机的信**息中（这样说
        边缘化就是“消元”）
![](/img/in-post/200906_slam8/2a81829f692660bc0519896bf802454e.png)
![](/img/in-post/200906_slam8/04dba4e951245db0c73c1ecc878e64b4.png)
